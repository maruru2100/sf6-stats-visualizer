services:
  db:
    image: postgres:15
    container_name: sf6_db
    # 個別の環境変数を削除し、.envファイルから一括読み込み
    env_file:
      - .env
    ports:
      - "5432:5432"
    volumes:
      - ./init-db:/docker-entrypoint-initdb.d
      - postgres_data:/var/lib/postgresql/data
    restart: always

  # --- Flywayサービス ---
  flyway:
    image: flyway/flyway:10
    command: >
      -url=jdbc:postgresql://db:5432/${POSTGRES_DB} 
      -user=${POSTGRES_USER:-postgres} 
      -password=${POSTGRES_PASSWORD} 
      -connectRetries=60 
      -baselineOnMigrate=true 
      migrate
    volumes:
      # root/flyway/sql をコンテナ内の /flyway/sql に繋ぐ
      - ./flyway/sql:/flyway/sql
    depends_on:
      - db

  # --- Scraperサービス ---
  scraper:
    build: ./scraper
    container_name: sf6_scraper
    env_file:
      - .env
    volumes:
      - ./scraper:/app
    ports:
      - "8501:8501"
    depends_on:
      db:
        condition: service_started
      flyway:
        condition: service_completed_successfully
    restart: always

  metabase:
    image: metabase/metabase
    container_name: sf6_metabase
    ports:
      - "3000:3000"
    volumes:
      - ./metabase-data:/metabase-data
    environment:
      - MB_DB_FILE=/metabase-data/metabase.db
    depends_on:
      - db
    restart: always
  
  tunnel:
    image: cloudflare/cloudflared:latest
    container_name: sf6_tunnel
    command: tunnel --url http://metabase:3000 --metrics 0.0.0.0:2000
    restart: always
    depends_on:
      - metabase
    profiles:
      - external
    networks:
      default:
        aliases:
          - sf6_tunnel
  
  # --- Discord Botサービス ---
  discord-bot:
    build: ./discord_bot
    container_name: sf6_discord_bot
    env_file:
      - .env
    environment:
      # /app(bot.pyがある場所) と /app/shared(database.pyがある場所) の両方にパスを通す
      - PYTHONPATH=/app:/app/shared
    volumes:
      - ./discord_bot:/app
      - ./scraper:/app/shared  # scraperをsharedというサブフォルダとしてマウント
    depends_on:
      - db
    profiles:
      - external
    restart: always

volumes:
  postgres_data: